save(list="enterotype", file=enterotypefile)
xsub
(xsub <- read.table(xsubfile, TRUE, "\t"))
xsubfile <- "~/Dropbox/R/enterotype_example/baseSampleInfo.txt"
(xsub <- read.table(xsubfile, TRUE, "\t"))
rownames(xsub) <- xsub[, "SampleID"]
xsub
xsubSM <- sampleMap(xsub)
xsubSM
merge_phyloseq(SM, xsubSM)
superSM <- merge_phyloseq(SM, xsubSM)
data.frame(superSM)
enterotype <- phyloseq(OTU, superSM, TT)
enterotype
Save to appropriate location in phyloseq package.#
enterotypefile <- "~/github/phyloseq_bioc/data/enterotype.RData"#
save(list="enterotype", file=enterotypefile)
nsamples(enterotype)
colnames(sampleMap(enterotype))
calcplot(enterotype ~ Enterotype)
x <- subset_samples(enterotype, !is.na(Enterotype))
x
calcplot(x ~ Enterotype)
nrow(sampleMap(x))
ncol(otuTable(x))
nrow(sampleMap(enterotype))
cca.phyloseq(x ~ Enterotype)
entcca <- cca.phyloseq(x ~ Enterotype)
ent.cca <- cca.phyloseq(x ~ Enterotype)
plot_ordination_phyloseq(ent.cca, x, site_color_category=Enterotype)
speciesSums(x)
speciesSums(x)==0
sum(speciesSums(x)==0)
species.names(x)[(speciesSums(x)==0)]
x <- prune_species(species.names(x)[(speciesSums(x)==0)], x)
calcplot(x ~ Enterotype)
sampleSums(x)
x <- subset_samples(enterotype, !is.na(Enterotype))
x <- prune_species(species.names(x)[(speciesSums(x)>0)], x)
sampleSums(x)
calcplot(x ~ Enterotype)
ent.cca <- cca.phyloseq(x ~ .)
?cca.phyloseq
ent.cca <- cca.phyloseq(x ~ Enterotype)
plot_ordination_phyloseq(ent.cca, x, site_color_category=Enterotype)
plot_ordination_phyloseq(ent.cca, x, site_color_category="Enterotype")
Make combined object:#
enterotype <- phyloseq(OTU, superSM, TT)#
#
# remove genera that don't appear anywhere (speciesSum is zero)#
enterotype <- prune_species(species.names(enterotype)[(speciesSums(enterotype)>0)], enterotype)#
#
# Save to appropriate location in phyloseq package.#
enterotypefile <- "~/github/phyloseq_bioc/data/enterotype.RData"#
save(list="enterotype", file=enterotypefile)
enterotype
data.frame(sampleMap(x))[, "Enterotype"]==2
mt(x, data.frame(sampleMap(x))[, "Enterotype"]==2)
' @aliases mt,phyloseq,ANY-method#
#' @rdname mt-methods#
setMethod("mt", c("phyloseq", "ANY"), function(physeq, classlabel, minPmaxT="minP", ...){#
	# If sampleMap slot is non-empty, and the classlabel is a character-class#
	# length(classlabel) == 1#
	if( !is.null(sampleMap(physeq, FALSE)) & class(classlabel)=="character" & length(classlabel)==1 ){#
		rawFactor  <- as(sampleMap(physeq), "data.frame")[, classlabel[1]]#
		if( class(rawFactor) != "factor" ){#
			rawFactor <- factor(rawFactor)#
		}#
		classlabel <- rawFactor#
	} # Either way, dispatch on otuTable(physeq)#
	mt(otuTable(physeq), classlabel, minPmaxT, ...)#
})
mt(x, data.frame(sampleMap(x))[, "Enterotype"]==2)
as(c(TRUE, FALSE), "integer")
Coerce logical to integer, pass-on#
#' @aliases mt,otuTable,logical-method#
#' @rdname mt-methods#
setMethod("mt", c("otuTable", "logical"), function(physeq, classlabel, minPmaxT="minP", ...){#
	mt(physeq, as(classlabel, "integer"), minPmaxT="minP", ...)#
})
mt(x, data.frame(sampleMap(x))[, "Enterotype"]==2)
soilrep example code, to go in the data documentation#
#################################################################################
library("phyloseq")#
#################################################################################
# Load the data#
#################################################################################
data(soilrep)#
#
#################################################################################
# Richness and sequencing effort example. Accept null hypothesis: #
# No convincing difference in species richness between warmed/unwarmed soils.#
#################################################################################
# Build data.frame with total sequencing reads and soil covariates#
DF <- data.frame(total.reads=sampleSums(soilrep), as(sampleData(soilrep), "data.frame"))#
# Calculate total (estimated) species richness for each sample and combine with DF#
DF <- data.frame(DF, t(round(estimateR(t(otuTable(soilrep))))))#
#
# Initialize ggplot data and color layers#
mancol <- c(no="blue", yes="red")#
p      <- ggplot(DF) + scale_fill_manual(values=mancol) + scale_colour_manual(values=mancol) #
#
# Build faceted histogram of the total-reads for each treatment type.#
p + geom_histogram(aes(x=total.reads, y=..count.., fill=warmed)) + facet_wrap(~ Treatment, 2)#
#
# Plot (estimated) richness versus sequencing effort (total reads)#
p + geom_point(aes(x=total.reads, y=S.chao1, color=warmed, shape=clipped), size=3.5)#
#
# Plot (estimated) richness versus observed richness#
p + geom_point(aes(x=S.obs, y=S.chao1, color=warmed, shape=clipped), size=3.5)#
#
# Did the warming or clipping treatments affect observed or estimated richness?#
par(mfcol=c(2, 2))#
boxplot(S.obs ~ warmed, DF, main="Did warming affect observed richness?", xlab="Warmed?")#
boxplot(S.chao1 ~ warmed, DF, main="Did warming affect estimated richness (Chao1)?", xlab="Warmed?")#
boxplot(S.obs ~ clipped, DF, main="Did clipping affect observed richness?", xlab="Clipped?")#
boxplot(S.chao1 ~ clipped, DF, main="Did clipping affect estimated richness (Chao1)?", xlab="Clipped?")#
# (For reference, here's a ggplot2 approach to making the boxplot):#
p + geom_boxplot(aes(Treatment, S.chao1, color=warmed))#
#
# The treatments do not appear to have affected the#
# estimated total richness between warmed/unwarmed soil samples#
t.test(x=subset(DF, warmed=="yes")[, "S.chao1"], y=subset(DF, warmed=="no")[, "S.chao1"])#
#
#################################################################################
# A beta diversity comparison.#
#################################################################################
jaccdist <- vegdist(t(otuTable(soilrep)), "jaccard")#
#
# soilMDS <- metaMDS(t(otuTable(soilrep)), "jaccard" )#
soilMDS <- metaMDS(jaccdist, "jaccard" )#
#
DF <- data.frame(DF, scores(soilMDS))#
ggplot(DF) + scale_color_manual(c("blue", "green", "red", "orange"))#
ggplot(DF) + geom_point(aes(x=NMDS1, y=NMDS2, color=Treatment))#
# Takes a long time.#
# calcplot(soilrep ~ Treatment)
p <- ggplot(DF) + scale_color_manual(c("blue", "green", "red", "orange"))
p + geom_point(aes(x=NMDS1, y=NMDS2, color=Treatment), 3)
p <- ggplot(DF) + scale_color_manual(c("blue", "green", "red", "orange"))
p + geom_point(aes(x=NMDS1, y=NMDS2, color=Treatment), size=3)
ggplot(DF) + geom_point(aes(x=NMDS1, y=NMDS2, color=Treatment), size=3)
?save
rm(list=ls())#
#################################################################################
# Load the requisite libraries.#
#################################################################################
library("phyloseq"); library("animate.phyloseq"); library("foreach"); library("doParallel")#
#
# Define the number of cores you want to use to perform calculations.#
Ncores <- 6#
#
#################################################################################
# Load and pre-process the data#
#################################################################################
# Load Katie's mouth data:#
load("~/Dropbox/R/Shelef_mouth_data_Nov2011/subgingival.Rdata")#
# Create a shortened name#
sg <- subgingival#
#################################################################################
# Checkout UniFrac on this data#
#################################################################################
print(nsamples(sg))#
print(nspecies(sg))
combn(nsamples(sg), 2)
test <- combn(nsamples(sg), 2)
dim(test)
nsamples(sg)
352*352
352*352/2
-352+352*352/2
sg10 <- prune_samples(sample.names(sg)[1:10], sg)
system.time(UniFrac(sg10, parallel=TRUE))$elapsed
registerDoParallel(makeCluster(Ncores))
system.time(UniFrac(sg10, parallel=TRUE))$elapsed
system.time(UniFrac(sg10, parallel=TRUE))
system.time(UniFrac(sg10, parallel=TRUE))["elapsed"]
sg20 <- prune_samples(sample.names(sg)[1:20], sg)
system.time(UniFrac(sg20, parallel=TRUE))["elapsed"]
sg40 <- prune_samples(sample.names(sg)[1:40], sg)
system.time(UniFrac(sg40, parallel=TRUE))["elapsed"]
sg80 <- prune_samples(sample.names(sg)[1:80], sg)
t80 <- system.time(UniFrac(sg80, parallel=TRUE))["elapsed"]
t80
sg120 <- prune_samples(sample.names(sg)[1:120], sg)
t120 <- system.time(UniFrac(sg120, parallel=TRUE))["elapsed"]
t120
c(t10, t20, t40, t80, t120)
t10 <- system.time(UniFrac(sg10, parallel=TRUE))["elapsed"]
c(t10, t20, t40, t80, t120)
t20 <- system.time(UniFrac(sg20, parallel=TRUE))["elapsed"]
c(t10, t20, t40, t80, t120)
t40 <- system.time(UniFrac(sg40, parallel=TRUE))["elapsed"]
samplenums <- seq(10, 130, 20)
samplenums
sn
samplenums
samplenums <- seq(10, 130, 20)#
registerDoParallel(makeCluster(Ncores))#
for( sn in samplenums ){#
	sgsn <- prune_samples(sample.names(sg)[1:sn], sg)	#
	UFtimes <- c(UFtimes, system.time(UniFrac(sgsn, parallel=TRUE))["elapsed"] )#
}#
df <- data.frame(comp.time=UFtimes, number.samples=samplenums)#
ggplot(df) + geom_point(aes(number.samples, comp.time))
UFtimes <- vector("numeric")
UFtimes
samplenums <- seq(10, 130, 20)#
registerDoParallel(makeCluster(Ncores))#
UFtimes <- vector("numeric")#
for( sn in samplenums ){#
	sgsn <- prune_samples(sample.names(sg)[1:sn], sg)	#
	UFtimes <- c(UFtimes, system.time(UniFrac(sgsn, parallel=TRUE))["elapsed"] )#
}#
df <- data.frame(comp.time=UFtimes, number.samples=samplenums)#
ggplot(df) + geom_point(aes(number.samples, comp.time))
df
dim(combn(130, 2))
dim(combn(130, 2))[2]
dim(combn(nsamples(sg), 2))[2]/dim(combn(130, 2))[2]
library("phyloseq")
bigTree <- read.tree("~/Downloads/Caporaso_Data/gg_tree/gg_97_otus_4feb2011.tre")
bigTree
data(GlobalPatterns)
all( species.names(GlobalPatterns) %in% species.names(bigTree) )
species.names(GlobalPatterns)
all( species.names(bigTree)        %in% species.names(GlobalPatterns) )
all( species.names(GlobalPatterns) %in% species.names(bigTree) )
bigTree
GlobalPatterns2 <- merge_phyloseq(GlobalPatterns, bigTree)
GlobalPatterns2
GlobalPatterns
cat("installing Bioconductor dependencies for local build \n")
cat("installing Bioconductor version of phyloseq \n")
source("https://github.com/downloads/joey711/phyloseq/phyloseq_install_github.R")
global_patterns_file2 <- "~/Downloads/mcmurdie/gaiix_pnas/GlobalPatterns2.RData"#
save(GlobalPatterns2, file=global_patterns_file2)
global_patterns_file2 <- "~/Downloads/Caporaso_Data/gaiix_pnas/GlobalPatterns2.RData"
save(GlobalPatterns2, file=global_patterns_file2)
GlobalPatterns2
?UniFrac
library("doParallel")
registerDoParallel(cores=6)
library("doParallel")#
registerDoParallel(cores=6)#
system.time(GPUF <- UniFrac(GlobalPatterns2, parallel=TRUE))#
#
## Documentation source for gobal-patterns data
456.558/60
?source
install_github
library(devtools)
install_github
GPUF
global_patterns_UF_file <- "~/Downloads/Caporaso_Data/gaiix_pnas/Unweighted_UniFrac.RData"
save(GPUF, file=global_patterns_UF_file)
MovingPicturesDataFile <- "~/Downloads/mcmurdie/moving_pictures/MovingPictures.RData"
load(MovingPicturesDataFile)
MovingPicturesDataFile <- "~/Downloads/Caporaso_Data/moving_pictures/MovingPictures.RData"
load(MovingPicturesDataFile)
all( species.names(MovingPictures) %in% species.names(bigTree) )
all( species.names(bigTree)        %in% species.names(MovingPictures) )
nspecies(MovingPictures)
system.time(MovingPictures2 <- merge_phyloseq(MovingPictures, bigTree))
MovingPictures2
MovingPicturesDataFile
MovingPictures
MovingPictures <- MovingPictures2
MovingPictures
save(MovingPictures, file=MovingPicturesDataFile)
MovingPictures
GlobalPatterns
GlobalPatterns2
all.equal(GlobalPatterns, phyloseq(otuTable(GlobalPatterns2), sampleData(GlobalPatterns2), taxTab(GlobalPatterns2)))
global_patterns_file <- "~/Downloads/mcmurdie/gaiix_pnas/GlobalPatterns.RData"
GlobalPatterns
GlobalPatterns2
GlobalPatterns <- GlobalPatterns2
global_patterns_file <- "~/Downloads/Caporaso_Data/gaiix_pnas/GlobalPatterns.RData"
global_patterns_file
save(GlobalPatterns, file=global_patterns_file)
getVariable(GlobalPatterns, "SampleType")
variable.names
variable.names(GlobalPatterns)
sample.variables(GlobalPatterns)
??"ranks"
print(GlobalPatterns)
tre
getMethod(tre, "character")
getMethod(tre, signature("character"))
help("ordinate")
library(phyloseq)
help("ordinate")
?import
import
import_biom
?import_biom
library(phyloseq)
?dpcoa
library(phyloseq)
data(esophagus)
distance(esophagus)
x <- distance(esophagus)
class(x)
?dca
?decorana
library(phyloseq)
?ordinate
Take a subset of the GP dataset for quicker computation of examples#
data(GlobalPatterns)#
# Keep top 200 species#
topsp <- names(sort(speciesSums(GlobalPatterns), TRUE)[1:200])#
GP    <- prune_species(topsp, GlobalPatterns)#
# Subset further to top 5 phyla#
top5ph <- sort(tapply(speciesSums(GP), taxTab(GP)[, "Phylum"], sum), decreasing=TRUE)[1:5]#
GP     <- subset_species(GP, Phylum %in% names(top5ph))#
##
# Examples performing ordination with NMDS. Default distance is unweighted UniFrac#
GP.NMDS.UF.ord   <- ordinate(GP, "NMDS")#
GP.NMDS.wUF.ord  <- ordinate(GP, "NMDS", "unifrac", weighted=TRUE)#
GP.NMDS.Bray.ord <- ordinate(GP, "NMDS", "bray")#
##
# # An example plot with default, or manually-defined shapes#
(p <- plot_ordination(GP, GP.NMDS.Bray.ord, "biplot", color="SampleType", shape="Phylum"))#
# define manual shape scale:#
man.shapes <- 21:25#
names(man.shapes) <- c(getTaxa(GP, "Phylum"))#
man.shapes <- c(samples=19, man.shapes)#
p + scale_shape_manual(value=man.shapes)#
##
# An example of constrained ordination#
GP.cca <- ordinate(GP~SampleType, "CCA")#
##
# Run-through "quick" plot examples of the other ordination options currently supported#
# Only showing "samples" in these examples, but "species" options supported for some methods#
plot_ordination(GP, ordinate(GP, "DCA"), "samples", color="SampleType")#
plot_ordination(GP, ordinate(GP, "CCA"), "samples", color="SampleType")#
plot_ordination(GP, ordinate(GP~SampleType, "CCA"), "samples", color="SampleType")#
plot_ordination(GP, ordinate(GP, "RDA"), "samples", color="SampleType")#
plot_ordination(GP, ordinate(GP~SampleType, "RDA"), "samples", color="SampleType")#
plot_ordination(GP, ordinate(GP, "DPCoA"), "samples", color="SampleType")#
plot_ordination(GP, ordinate(GP, "MDS"), "samples", color="SampleType")#
plot_ordination(GP, ordinate(GP, "PCoA"), "samples", color="SampleType")#
plot_ordination(GP, ordinate(GP, "NMDS"), "samples", color="SampleType")#
plot_ordination(GP, ordinate(GP, "NMDS", "w"), "samples", color="SampleType")
ordinate(GP, "NMDS", "w")
x <- ordinate(GP, "NMDS", "w")
str(x)
scores(x, choices="species")
scores(x, choices="sites")
?scores
scores(x, display="species")
scores(x, display="sites")
?metaMDS
x <- ordinate(GP, "NMDS", "w", plot=TRUE)
ordinate(GP, "NMDS", "w", plot=TRUE)
plot_ordination(GP, ordinate(GP, "MDS"), "samples", color="SampleType")
plot_ordination(GP, ordinate(GP, "MDS"), "samples", color="SampleType") + geom_line()
GP.UF <- distance(GP)
GP.UF
plot_ordination(GP, ordinate(GP, "MDS", GP.UF), "samples", color="SampleType") + geom_line()
GP.UF
plot_ordination(GP, ordinate(GP, "MDS"), "samples", color="SampleType") + geom_line()
plot_ordination(GP, ordinate(GP, "PCoA", GP.UF), "samples", color="SampleType") + geom_line()
plot_ordination(GP, ordinate(GP, "NMDS", GP.UF), "samples", color="SampleType") + geom_line()
?ordinate
Try example from Jensen-Shannon Divergence (JSD) documentation#
library(doParallel)#
registerDoParallel(cores=7)#
data(enterotype)#
# ent.jsd <- JSD(enterotype, TRUE) # internal only#
ent.jsd <- distance(enterotype, "jsd", parallel=TRUE)#
ent.ord <- ordinate(enterotype, "PCoA", ent.jsd) # Perform principle coordinate analysis#
(p <- plot_ordination(enterotype, ent.ord, color="Enterotype", shape="SeqTech") )
p <- p + geom_point(size=4, alpha=0.5)
(p <- plot_ordination(enterotype, ent.ord, color="Enterotype", shape="SeqTech") )
p + geom_point(size=4, alpha=0.5)
p + geom_point(size=5, alpha=0.5)
p <- p + geom_point(size=5, alpha=0.5)
p + facet_wrap(~SeqTech)
p <- plot_ordination(enterotype, ent.ord, color="Enterotype", shape="SeqTech") #
(p <- p + geom_point(size=5, alpha=0.5))
ent.PCoA <- ordinate(enterotype, "PCoA", ent.jsd) # Perform principle coordinate analysis
What about redundancy analysis #
ent.rda <- ordinate(enterotype, "RDA", ent.jsd) # RDA instead#
p <- plot_ordination(enterotype, ent.rda, color="Enterotype", shape="SeqTech") #
(p <- p + geom_point(size=5, alpha=0.5))
ggsave("~/Downloads/enterotype-JSD-rda.pdf", width=10, height=8)
ent.rda <- ordinate(enterotype, "RDA") # RDA instead
p <- plot_ordination(enterotype, ent.rda, color="Enterotype", shape="SeqTech")
(p <- p + geom_point(size=5, alpha=0.5))
ent.PCoA <- ordinate(enterotype, "PCoA", ent.jsd) # Perform principle coordinate analysis#
p <- plot_ordination(enterotype, ent.PCoA, color="Enterotype", shape="SeqTech") #
(p <- p + geom_point(size=5, alpha=0.5))#
ggsave("~/Downloads/enterotype-JSD-PCoA.pdf", width=10, height=8)#
#
# What about redundancy analysis #
ent.rda <- ordinate(enterotype, "RDA") # RDA instead#
p <- plot_ordination(enterotype, ent.rda, color="Enterotype", shape="SeqTech") #
(p <- p + geom_point(size=5, alpha=0.5))#
ggsave("~/Downloads/enterotype-rda.pdf", width=10, height=8)
library(devtools)
install_github("phyloseq", "joey711")
library(phyloseq)
ptex
data(esophagus)
plot_tree(esophagus)
library(ggplot2)
p1 <- last_plot()
p1
plot_tree(esophagus, color="samples")
do.call("p1")
eval("p1")
eval(parse(text="p1"))
test <- eval(parse(text="p1"))
test
class(test)
class(test)
i <- 1
ggsave(paste(ptex_dir, "p", i, ".pdf", sep=""), plot=eval(parse(text=paste("p", i, sep=""))), width=400, height=400)
ptex_dir <- "~/Dropbox/R/plot_tree_github_examples/"
ggsave(paste(ptex_dir, "p", i, ".pdf", sep=""), plot=eval(parse(text=paste("p", i, sep=""))), width=400, height=400)
plot_tree(esophagus)
ggsave(paste(ptex_dir, "p", i, ".pdf", sep=""), p1, width=400, height=400)
p1
Using plot_tree with the esophagus dataset.#
data(esophagus)#
plot_tree(esophagus)#
p1 <- last_plot()#
#
plot_tree(esophagus, color="samples")#
p2 <- last_plot()#
#
plot_tree(esophagus, size="abundance")#
p3 <- last_plot()#
#
plot_tree(esophagus, size="abundance", color="samples")#
p4 <- last_plot()#
#
plot_tree(esophagus, size="abundance", color="samples", base.spacing=0.03)#
p5 <- last_plot()
ggsave(paste(ptex_dir, "p", 5, ".pdf", sep=""), p1, width=400, height=400)
ggsave(paste(ptex_dir, "p", 5, ".pdf", sep=""), p5, width=400, height=400)
ggsave(paste(ptex_dir, "p", 5, ".png", sep=""), p5, width=400, height=400)
